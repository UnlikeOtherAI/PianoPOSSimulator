<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Piano SIM POS</title>
    <meta name="theme-color" content="#f7f2ea" />
    <meta property="og:title" content="Piano SIM POS" />
    <meta property="og:description" content="POS purchase simulator catalog." />
    <meta property="og:image" content="/og-image.png" />
    <meta property="og:type" content="website" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Piano SIM POS" />
    <meta name="twitter:description" content="POS purchase simulator catalog." />
    <meta name="twitter:image" content="/og-image.png" />
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png" />
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png" />
    <link rel="icon" href="/favicon.ico" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
      .panel-animate-out {
        animation: panelOut 0.18s cubic-bezier(0.4, 0, 1, 1) forwards;
      }
      .panel-animate-in {
        animation: panelIn 0.55s cubic-bezier(0.2, 0.9, 0.22, 1.1) both;
      }
      @keyframes panelOut {
        from {
          opacity: 1;
          transform: translateX(0);
        }
        to {
          opacity: 0;
          transform: translateX(-140px);
        }
      }
      @keyframes panelIn {
        0% {
          opacity: 0;
          transform: translateX(140px);
        }
        70% {
          opacity: 1;
          transform: translateX(-10px);
        }
        100% {
          opacity: 1;
          transform: translateX(0);
        }
      }
    </style>
  </head>
  <body class="min-h-screen bg-[#f7f2ea] flex flex-col items-center px-6">
    <div class="w-full max-w-5xl flex-1 py-12">
      <div class="mx-auto w-full max-w-lg rounded-2xl border border-[#e2d6c2] bg-[#fffaf0] px-10 py-12 text-center shadow-[0_30px_80px_rgba(0,0,0,0.18)]">
        <img class="mx-auto mb-6 h-20 w-20" src="/assets/wolf.png" alt="Unlike Other AI" />
        <h1 class="text-3xl font-semibold tracking-wide text-[#1d1b16]">Piano SIM POS</h1>
        <p class="mt-3 text-sm text-[#4b443b]">
          POS purchase simulator catalog. Data is loaded from a single JSON file.
        </p>
        <div class="mt-8 flex flex-col gap-3">
          <a
            class="w-full rounded-full border border-[#1d1b16] px-6 py-3 text-sm font-semibold uppercase tracking-widest text-[#1d1b16] transition hover:bg-[#1d1b16] hover:text-[#fffaf0]"
            href="https://github.com/UnlikeOtherAI/PianoPOSSimulator/"
            target="_blank"
            rel="noreferrer"
          >
            GitHub
          </a>
          <a
            class="w-full rounded-full bg-[#1d1b16] px-6 py-3 text-sm font-semibold uppercase tracking-widest text-[#fffaf0] transition hover:opacity-90"
            href="https://www.unlikeotherai.com"
            target="_blank"
            rel="noreferrer"
          >
            Unlike Other AI
          </a>
        </div>
      </div>
      <div class="mt-10 flex justify-center">
        <button
          id="make-sale-button"
          class="rounded-full border border-[#1d1b16] bg-[#1d1b16] px-8 py-3 text-xs font-semibold uppercase tracking-[0.36em] text-[#fffaf0] transition hover:opacity-90"
          type="button"
        >
          Make Sale
        </button>
      </div>
      <section class="mt-10">
        <div id="shop-tabs" class="flex flex-wrap gap-4 justify-center"></div>
        <div id="shop-panel" class="mt-6 rounded-2xl border border-[#e2d6c2] bg-[#fffaf0] px-8 py-6 shadow-[0_24px_60px_rgba(0,0,0,0.12)]">
          <div class="grid gap-6 md:grid-cols-[1fr_auto_1fr] md:items-center">
            <div class="flex flex-col gap-2">
              <p class="text-xs font-semibold uppercase tracking-[0.28em] text-[#4b443b]">Weekly flow</p>
              <div class="h-44 rounded-xl border border-[#e2d6c2] bg-white p-3">
                <canvas id="shop-week-chart"></canvas>
              </div>
            </div>
            <div class="flex flex-col items-center gap-3 text-center">
              <img
                id="shop-logo"
                class="h-[180px] w-[180px] object-contain"
                src=""
                alt=""
              />
              <h2 id="shop-title" class="text-2xl font-semibold text-[#1d1b16]"></h2>
              <p id="shop-meta" class="text-sm text-[#4b443b]"></p>
              <p id="shop-hours" class="text-xs uppercase tracking-[0.28em] text-[#1d1b16]"></p>
              <p id="shop-status" class="text-[11px] uppercase tracking-[0.28em] text-[#4b443b]"></p>
              <div id="shop-items" class="text-sm text-[#4b443b]"></div>
            </div>
            <div class="flex flex-col gap-2">
              <p class="text-xs font-semibold uppercase tracking-[0.28em] text-[#4b443b]">Daily flow</p>
              <div class="h-44 rounded-xl border border-[#e2d6c2] bg-white p-3">
                <canvas id="shop-hour-chart"></canvas>
              </div>
            </div>
          </div>
          <div class="mt-8">
            <div id="shop-section-tabs" class="flex flex-wrap gap-2 justify-center"></div>
            <div class="mt-4 overflow-hidden rounded-xl border border-[#e2d6c2] bg-white">
              <table class="w-full text-left text-sm text-[#4b443b]">
                <tbody id="shop-section-rows"></tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
      <div class="mt-[75px] flex justify-center">
        <img class="h-[150px] w-auto" src="/assets/thistle.png" alt="Thistle" />
      </div>
    </div>
    <footer class="mt-[44px] h-[75px] w-screen bg-[#1d1b16] text-center text-[11px] uppercase tracking-[0.32em] text-[#f7f2ea]/70">
      <div class="mx-auto flex h-full max-w-5xl items-center justify-center">
        <span>
          Made with love in Scotland by
          <a
            class="ml-2 text-[#fffaf0] no-underline"
            href="https://www.unlikeotherai.com"
            target="_blank"
            rel="noreferrer"
          >
            Unlike Other AI
          </a>
        </span>
      </div>
    </footer>
    <div
      id="sale-modal"
      class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 px-6"
    >
      <div class="w-full max-w-4xl rounded-2xl border border-[#e2d6c2] bg-[#fffaf0] p-6 shadow-[0_30px_80px_rgba(0,0,0,0.3)]">
        <div class="flex flex-col items-center gap-4">
          <h3 class="text-lg font-semibold text-[#1d1b16]">Generated Sales</h3>
          <button
            id="make-another-sale"
            class="rounded-full border border-[#1d1b16] bg-[#1d1b16] px-6 py-2 text-xs font-semibold uppercase tracking-[0.28em] text-[#fffaf0] transition hover:opacity-90"
            type="button"
          >
            Make Another
          </button>
        </div>
        <div class="mt-4 flex justify-end">
          <button
            id="close-sale-modal"
            class="rounded-full border border-[#1d1b16] px-4 py-2 text-xs font-semibold uppercase tracking-[0.28em] text-[#1d1b16]"
            type="button"
          >
            Close
          </button>
        </div>
        <div
          id="sale-results"
          class="mt-5 grid gap-4 md:grid-cols-2"
        ></div>
      </div>
    </div>
    <div
      id="item-modal"
      class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40 px-6"
    >
      <div class="w-full max-w-3xl rounded-2xl border border-[#e2d6c2] bg-[#fffaf0] p-6 shadow-[0_30px_80px_rgba(0,0,0,0.3)]">
        <div class="flex items-center justify-between">
          <h3 id="item-modal-title" class="text-lg font-semibold text-[#1d1b16]">Item details</h3>
          <button
            id="close-item-modal"
            class="rounded-full border border-[#1d1b16] px-4 py-2 text-xs font-semibold uppercase tracking-[0.28em] text-[#1d1b16]"
            type="button"
          >
            Close
          </button>
        </div>
        <div id="item-modal-body" class="mt-5 space-y-4 text-sm text-[#4b443b]"></div>
      </div>
    </div>
    <script>
      const panelEl = document.getElementById("shop-panel");
      const tabsEl = document.getElementById("shop-tabs");
      const logoEl = document.getElementById("shop-logo");
      const titleEl = document.getElementById("shop-title");
      const metaEl = document.getElementById("shop-meta");
      const hoursEl = document.getElementById("shop-hours");
      const statusEl = document.getElementById("shop-status");
      const itemsEl = document.getElementById("shop-items");
      const weekChartEl = document.getElementById("shop-week-chart");
      const hourChartEl = document.getElementById("shop-hour-chart");
      const sectionTabsEl = document.getElementById("shop-section-tabs");
      const sectionRowsEl = document.getElementById("shop-section-rows");
      const saleButtonEl = document.getElementById("make-sale-button");
      const saleModalEl = document.getElementById("sale-modal");
      const saleResultsEl = document.getElementById("sale-results");
      const closeSaleModalEl = document.getElementById("close-sale-modal");
      const makeAnotherSaleEl = document.getElementById("make-another-sale");
      const itemModalEl = document.getElementById("item-modal");
      const itemModalTitleEl = document.getElementById("item-modal-title");
      const itemModalBodyEl = document.getElementById("item-modal-body");
      const closeItemModalEl = document.getElementById("close-item-modal");
      let currentShop = null;
      let animationTimer = null;
      let dataCache = null;
      let weeklyChart = null;
      let hourlyChart = null;
      let chartToken = 0;
      let currentSectionIndex = 0;
      let currentSectionRows = [];

      const BUSYNESS_WEEKLY = {
        "urn:establishment:sim-pub-001": "/data/busyness-weekly-rock-bottom.json",
        "urn:establishment:sim-petrol-001": "/data/busyness-weekly-scottish-diesel.json",
        "urn:establishment:sim-shop-001": "/data/busyness-weekly-get-naked.json",
        "urn:establishment:sim-truck-001": "/data/busyness-weekly-la-mordida.json",
      };
      const BUSYNESS_HOURLY = {
        "urn:establishment:sim-pub-001": "/data/busyness-rock-bottom.json",
        "urn:establishment:sim-petrol-001": "/data/busyness-scottish-diesel.json",
        "urn:establishment:sim-shop-001": "/data/busyness-get-naked.json",
        "urn:establishment:sim-truck-001": "/data/busyness-la-mordida.json",
      };
      const busynessCache = { weekly: {}, hourly: {} };

      const fetchData = async () => {
        const response = await fetch("/data/items.json");
        if (!response.ok) {
          throw new Error("Unable to load items.json");
        }
        return response.json();
      };

      const fetchBusyness = async (url, cache, key) => {
        if (!url) return null;
        if (cache[key]) return cache[key];
        const response = await fetch(url);
        if (!response.ok) return null;
        const data = await response.json();
        cache[key] = data;
        return data;
      };

      const toMinutes = (value) => {
        const [hour, minute] = value.split(":").map(Number);
        return hour * 60 + minute;
      };

      const isMinuteInRange = (minute, start, end) => {
        if (start === end) return true;
        if (start < end) return minute >= start && minute < end;
        return minute >= start || minute < end;
      };

      const buildHourlySeries = (hourlyData) => {
        if (!hourlyData?.baselinePurchasesPer5Min) return Array(24).fill(0);
        const segments = hourlyData.baselinePurchasesPer5Min.map((seg) => ({
          start: toMinutes(seg.start),
          end: toMinutes(seg.end),
          avg: (seg.min + seg.max) / 2,
        }));
        return Array.from({ length: 24 }, (_, hour) => {
          const minute = hour * 60;
          const segment = segments.find((seg) =>
            isMinuteInRange(minute, seg.start, seg.end)
          );
          if (!segment) return 0;
          return Number((segment.avg * 12).toFixed(1));
        });
      };

      const buildWeeklySeries = (weeklyData) => {
        const days = [
          "Monday",
          "Tuesday",
          "Wednesday",
          "Thursday",
          "Friday",
          "Saturday",
          "Sunday",
        ];
        return days.map((day) => {
          const entries = weeklyData?.days?.[day] || [];
          if (!entries.length) return 0;
          const total = entries.reduce(
            (sum, entry) => sum + (entry.min + entry.max) / 2,
            0
          );
          return Number((total / entries.length).toFixed(1));
        });
      };

      const formatPrice = (value) => {
        const num = Number(value);
        if (Number.isNaN(num)) return value;
        return num.toFixed(2);
      };

      const hashString = (value) => {
        let hash = 2166136261;
        for (let i = 0; i < value.length; i += 1) {
          hash ^= value.charCodeAt(i);
          hash = Math.imul(hash, 16777619);
        }
        return hash >>> 0;
      };

      const clamp = (value, min, max) => Math.min(Math.max(value, min), max);

      const magicNumberFor = (establishmentId, itemName, price) => {
        const fiscalDate = new Date().toISOString().slice(0, 10);
        const seed = `${fiscalDate}|${establishmentId}|${itemName}`;
        const base = 30 + (hashString(seed) % 61);
        const priceValue = Number(price) || 0;
        let modifier = 0;
        if (priceValue >= 120) modifier -= 20;
        else if (priceValue >= 60) modifier -= 12;
        else if (priceValue >= 30) modifier -= 6;
        else if (priceValue <= 5) modifier += 12;
        else if (priceValue <= 10) modifier += 6;
        return clamp(base + modifier, 5, 95);
      };

      const findIndex = (headers, candidates) =>
        headers.findIndex((header) =>
          candidates.some((cand) => header.toLowerCase() === cand)
        );

      const findPriceIndices = (headers) =>
        headers
          .map((header, index) => ({ header, index }))
          .filter((item) => item.header.toLowerCase().includes("price"))
          .map((item) => item.index);

      const renderSectionRows = (establishment, sectionIndex) => {
        const section = establishment?.sections?.[sectionIndex];
        if (!section) {
          sectionRowsEl.innerHTML = "";
          currentSectionRows = [];
          return;
        }
        const nameIndex = findIndex(section.headers, ["name", "item"]);
        const codeIndex = 0;
        const rawCodeLabel = section.headers[codeIndex] || "Code";
        const codeLabel = rawCodeLabel.split(" ")[0];
        const priceIndices = findPriceIndices(section.headers);
        const primaryPriceIndex = priceIndices[0] ?? section.headers.length - 1;
        const secondaryPriceIndex = priceIndices[1];
        const vatIndex = section.headers.findIndex(
          (header) => header.toLowerCase() === "vatrate"
        );

        currentSectionRows = section.rows.map((row) => ({
          row,
          headers: section.headers,
          title: section.title,
          establishment,
        }));
        sectionRowsEl.innerHTML = section.rows
          .map((row, idx) => {
            const name = row[nameIndex >= 0 ? nameIndex : 1] ?? row[1] ?? row[0];
            const codeValue = row[codeIndex] ?? "";
            const priceValue = row[primaryPriceIndex] ?? "";
            const vatRate = vatIndex >= 0 ? Number(row[vatIndex]) : null;
            const isVatRegistered = Boolean(establishment.vatRegistered);
            const hasVat = isVatRegistered && vatRate && vatRate > 0;
            const priceNum = Number(priceValue);
            const exVat = hasVat && !Number.isNaN(priceNum)
              ? priceNum / (1 + vatRate)
              : null;
            const secondaryPrice =
              secondaryPriceIndex !== undefined ? row[secondaryPriceIndex] : null;
            const secondaryLabel =
              secondaryPriceIndex !== undefined
                ? section.headers[secondaryPriceIndex]
                : null;
            const rowClass = idx % 2 === 0 ? "bg-[#fcfaf6]" : "bg-white";

            return (
              '<tr class="' +
              rowClass +
              ' cursor-pointer transition hover:bg-[#f3ede3]" data-row-index="' +
              idx +
              '">' +
              '<td class="px-4 py-3">' +
              '<div class="font-semibold text-[#1d1b16]">' +
              name +
              "</div>" +
              '<div class="text-[11px] uppercase tracking-[0.22em] text-[#7a6f62]">' +
              codeLabel +
              " " +
              codeValue +
              "</div>" +
              (secondaryPrice && secondaryLabel
                ? '<div class="mt-1 text-[11px] text-[#7a6f62]">' +
                  secondaryLabel +
                  ": £" +
                  formatPrice(secondaryPrice) +
                  "</div>"
                : "") +
              "</td>" +
              '<td class="px-4 py-3 text-right">' +
              '<div class="text-base font-semibold text-[#1d1b16]">£' +
              formatPrice(priceValue) +
              (hasVat ? " (inc VAT)" : "") +
              "</div>" +
              (exVat !== null
                ? '<div class="text-[11px] uppercase tracking-[0.22em] text-[#7a6f62]">£' +
                  formatPrice(exVat) +
                  " ex VAT</div>"
                : "") +
              "</td>" +
              "</tr>"
            );
          })
          .join("");
      };

      const renderItemModal = (entry) => {
        if (!entry) return;
        const { row, headers, title, establishment } = entry;
        const details = headers.map((header, index) => ({
          label: header,
          value: row[index],
        }));
        const nameIndex = findIndex(headers, ["name", "item"]);
        const name = row[nameIndex >= 0 ? nameIndex : 1] ?? row[1] ?? row[0];
        const priceIndex = findPriceIndices(headers)[0] ?? headers.length - 1;
        const price = row[priceIndex];
        const magicNumber = magicNumberFor(establishment.id, name, price);

        itemModalTitleEl.textContent = name;
        itemModalBodyEl.innerHTML =
          '<div class="rounded-xl border border-[#e2d6c2] bg-white p-4">' +
          '<div class="text-xs font-semibold uppercase tracking-[0.28em] text-[#7a6f62]">Section</div>' +
          '<div class="mt-1 text-sm font-semibold text-[#1d1b16]">' +
          title +
          "</div>" +
          "</div>" +
          '<div class="rounded-xl border border-[#e2d6c2] bg-white p-4">' +
          '<div class="text-xs font-semibold uppercase tracking-[0.28em] text-[#7a6f62]">Magic number</div>' +
          '<div class="mt-2 text-sm text-[#4b443b]">Each item gets a daily magic number (5–95) derived from date, business ID, and item name. The simulator rolls 1–100 each time it considers this item; if the roll is at or below the magic number, the item is allowed into a basket.</div>' +
          '<div class="mt-3 text-sm font-semibold text-[#1d1b16]">Current magic number: ' +
          magicNumber +
          "</div>" +
          '<div class="mt-2 text-xs text-[#7a6f62]">Price nudges the score: pricey items are less likely, cheap items more likely.</div>' +
          "</div>" +
          '<div class="rounded-xl border border-[#e2d6c2] bg-white p-4">' +
          '<div class="text-xs font-semibold uppercase tracking-[0.28em] text-[#7a6f62]">Full details</div>' +
          '<dl class="mt-2 grid gap-2 md:grid-cols-2">' +
          details
            .map(
              (detail) =>
                '<div class="text-xs text-[#4b443b]">' +
                '<div class="uppercase tracking-[0.22em] text-[#7a6f62]">' +
                detail.label +
                "</div>" +
                '<div class="mt-1 text-sm text-[#1d1b16]">' +
                detail.value +
                "</div>" +
                "</div>"
            )
            .join("") +
          "</dl>" +
          "</div>";
        itemModalEl.classList.remove("hidden");
        itemModalEl.classList.add("flex");
      };

      const closeItemModal = () => {
        itemModalEl.classList.add("hidden");
        itemModalEl.classList.remove("flex");
      };

      const renderSectionTabs = (establishment) => {
        const sections = establishment?.sections || [];
        if (!sections.length) {
          sectionTabsEl.innerHTML = "";
          sectionRowsEl.innerHTML = "";
          return;
        }
        currentSectionIndex = Math.min(currentSectionIndex, sections.length - 1);
        sectionTabsEl.innerHTML = sections
          .map(
            (section, idx) =>
              '<button data-index="' +
              idx +
              '" class="rounded-full border border-[#1d1b16] px-4 py-1.5 text-[10px] font-semibold uppercase tracking-[0.28em] text-[#1d1b16]">' +
              section.title +
              "</button>"
          )
          .join("");
        Array.from(sectionTabsEl.querySelectorAll("button")).forEach((button) => {
          const idx = Number(button.dataset.index);
          const isActive = idx === currentSectionIndex;
          button.classList.toggle("bg-[#1d1b16]", isActive);
          button.classList.toggle("text-[#fffaf0]", isActive);
          button.style.backgroundColor = isActive ? "#1d1b16" : "transparent";
          button.style.color = isActive ? "#fffaf0" : "#1d1b16";
          button.addEventListener("click", () => {
            currentSectionIndex = idx;
            renderSectionTabs(establishment);
            renderSectionRows(establishment, currentSectionIndex);
          });
        });
        renderSectionRows(establishment, currentSectionIndex);
      };

      const renderCharts = async (establishment) => {
        if (!window.Chart || !establishment) return;
        const token = ++chartToken;
        const weekly = await fetchBusyness(
          BUSYNESS_WEEKLY[establishment.id],
          busynessCache.weekly,
          establishment.id
        );
        const hourly = await fetchBusyness(
          BUSYNESS_HOURLY[establishment.id],
          busynessCache.hourly,
          establishment.id
        );
        if (token !== chartToken) return;
        const weeklySeries = buildWeeklySeries(weekly);
        const hourlySeries = buildHourlySeries(hourly);

        if (weeklyChart) weeklyChart.destroy();
        if (hourlyChart) hourlyChart.destroy();

        weeklyChart = new Chart(weekChartEl, {
          type: "bar",
          data: {
            labels: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"],
            datasets: [
              {
                data: weeklySeries,
                backgroundColor: "#d2c1a5",
                borderRadius: 6,
              },
            ],
          },
          options: {
            animation: false,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: { enabled: false },
            },
            scales: {
              x: {
                grid: { display: false },
                ticks: { color: "#4b443b", font: { size: 10 } },
              },
              y: {
                grid: { color: "rgba(0,0,0,0.06)" },
                ticks: { color: "#4b443b", font: { size: 10 }, maxTicksLimit: 4 },
              },
            },
          },
        });

        hourlyChart = new Chart(hourChartEl, {
          type: "line",
          data: {
            labels: Array.from({ length: 24 }, (_, hour) => String(hour)),
            datasets: [
              {
                data: hourlySeries,
                borderColor: "#1d1b16",
                backgroundColor: "rgba(29,27,22,0.12)",
                fill: true,
                tension: 0.35,
                pointRadius: 0,
              },
            ],
          },
          options: {
            animation: false,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: { enabled: false },
            },
            scales: {
              x: {
                grid: { display: false },
                ticks: {
                  color: "#4b443b",
                  font: { size: 10 },
                  callback: (value) => (value % 4 === 0 ? value : ""),
                },
              },
              y: {
                grid: { color: "rgba(0,0,0,0.06)" },
                ticks: { color: "#4b443b", font: { size: 10 }, maxTicksLimit: 4 },
              },
            },
          },
        });
      };

      const summarizeOrders = (orders) => {
        const summary = {};
        let total = 0;
        for (const order of orders) {
          for (const item of order.items || []) {
            const key = item.name;
            if (!summary[key]) {
              summary[key] = { name: item.name, quantity: 0, total: 0 };
            }
            summary[key].quantity += item.quantity;
            summary[key].total += item.totalGrossPrice;
            total += item.totalGrossPrice;
          }
        }
        return {
          items: Object.values(summary).sort((a, b) => b.total - a.total),
          total,
        };
      };

      const openSaleModal = (payload) => {
        if (!payload?.results) return;
        saleResultsEl.innerHTML = payload.results
          .map((result) => {
            const summary = summarizeOrders(result.orders || []);
            const items = summary.items.length
              ? summary.items
                  .slice(0, 8)
                  .map(
                    (item) =>
                      '<li class="flex justify-between text-xs text-[#4b443b]">' +
                      '<span>' +
                      item.name +
                      "</span>" +
                      '<span class="text-[#1d1b16]">' +
                      item.quantity +
                      "x £" +
                      formatPrice(item.total) +
                      "</span>" +
                      "</li>"
                  )
                  .join("")
              : '<li class="text-xs text-[#7a6f62]">No sales generated.</li>';
            return (
              '<div class="rounded-xl border border-[#e2d6c2] bg-white p-4">' +
              '<div class="flex items-center gap-3">' +
              '<img class="h-10 w-10 object-contain" src="' +
              result.logo +
              '" alt="' +
              result.name +
              ' logo" />' +
              '<div>' +
              '<div class="text-sm font-semibold text-[#1d1b16]">' +
              result.name +
              "</div>" +
              '<div class="text-[11px] uppercase tracking-[0.22em] text-[#7a6f62]">' +
              (result.orders?.length || 0) +
              " orders</div>" +
              "</div>" +
              "</div>" +
              '<div class="mt-3 text-xs text-[#1d1b16]">Total £' +
              formatPrice(summary.total) +
              "</div>" +
              '<ul class="mt-2 space-y-2">' +
              items +
              "</ul>" +
              "</div>"
            );
          })
          .join("");
        saleModalEl.classList.remove("hidden");
        saleModalEl.classList.add("flex");
      };

      const closeSaleModal = () => {
        saleModalEl.classList.add("hidden");
        saleModalEl.classList.remove("flex");
      };

      const getEdinburghMinutes = () => {
        const parts = new Intl.DateTimeFormat("en-GB", {
          timeZone: "Europe/London",
          hour: "2-digit",
          minute: "2-digit",
          hour12: false,
        }).formatToParts(new Date());
        const hour = Number(parts.find((part) => part.type === "hour")?.value ?? 0);
        const minute = Number(parts.find((part) => part.type === "minute")?.value ?? 0);
        return hour * 60 + minute;
      };

      const weekdayIndex = (day) => {
        const days = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
        return days.indexOf(day);
      };

      const parseHours = (hours) => {
        const match = hours.match(
          /^(?:(Mon|Tue|Wed|Thu|Fri|Sat|Sun)(?:-(Mon|Tue|Wed|Thu|Fri|Sat|Sun))\s+)?(\d{2}):(\d{2})-(\d{2}):(\d{2})\s*GMT$/
        );
        if (!match) return null;
        return {
          dayStart: match[1] ? weekdayIndex(match[1]) : null,
          dayEnd: match[2] ? weekdayIndex(match[2]) : match[1] ? weekdayIndex(match[1]) : null,
          open: Number(match[3]) * 60 + Number(match[4]),
          close: Number(match[5]) * 60 + Number(match[6]),
        };
      };

      const getEdinburghWeekday = () => {
        const parts = new Intl.DateTimeFormat("en-GB", {
          timeZone: "Europe/London",
          weekday: "short",
        }).formatToParts(new Date());
        const label = parts.find((part) => part.type === "weekday")?.value ?? "Mon";
        return weekdayIndex(label.slice(0, 3));
      };

      const isDayAllowed = (dayStart, dayEnd, today) => {
        if (dayStart === null || dayEnd === null) return true;
        if (dayStart <= dayEnd) {
          return today >= dayStart && today <= dayEnd;
        }
        return today >= dayStart || today <= dayEnd;
      };

      const isOpenNow = (hours) => {
        if (!hours) return false;
        const parsed = parseHours(hours);
        if (!parsed) return false;
        const now = getEdinburghMinutes();
        const today = getEdinburghWeekday();
        const yesterday = (today + 6) % 7;
        const dayAllowedToday = isDayAllowed(parsed.dayStart, parsed.dayEnd, today);
        const dayAllowedYesterday = isDayAllowed(parsed.dayStart, parsed.dayEnd, yesterday);

        if (parsed.open === 0 && parsed.close === 1440) {
          return dayAllowedToday;
        }

        if (parsed.close <= parsed.open) {
          if (now >= parsed.open) {
            return dayAllowedToday;
          }
          return dayAllowedYesterday;
        }
        return dayAllowedToday && now >= parsed.open && now < parsed.close;
      };

      const updateStatus = (establishment) => {
        if (!establishment) return;
        statusEl.textContent =
          (isOpenNow(establishment.hours) ? "Open now" : "Closed now") +
          " (Europe/Edinburgh)";
      };

      const updateTabs = (activeId) => {
        Array.from(tabsEl.querySelectorAll("button")).forEach((button) => {
          const isActive = button.dataset.id === activeId;
          button.classList.toggle("bg-[#1d1b16]", isActive);
          button.classList.toggle("text-[#fffaf0]", isActive);
          button.classList.toggle("text-[#1d1b16]", !isActive);
          button.style.backgroundColor = isActive ? "#1d1b16" : "transparent";
          button.style.color = isActive ? "#fffaf0" : "#1d1b16";
        });
      };

      const renderEstablishment = (establishment) => {
        if (!establishment) return;
        currentShop = establishment;
        logoEl.src = establishment.logo || "/assets/wolf.png";
        logoEl.alt = establishment.name + " logo";
        titleEl.textContent = establishment.name;
        metaEl.textContent = establishment.meta;
        hoursEl.textContent = establishment.hours;
        updateStatus(establishment);
        updateTabs(establishment.id);
        itemsEl.textContent = "";
        renderCharts(establishment);
        renderSectionTabs(establishment);
      };

      const animateSwitch = (establishment) => {
        if (!panelEl) {
          renderEstablishment(establishment);
          return;
        }
        if (currentShop && establishment.id === currentShop.id) return;
        updateTabs(establishment.id);
        if (animationTimer) {
          clearTimeout(animationTimer);
        }
        panelEl.classList.remove("panel-animate-in");
        panelEl.classList.add("panel-animate-out");
        animationTimer = setTimeout(() => {
          renderEstablishment(establishment);
          panelEl.classList.remove("panel-animate-out");
          void panelEl.offsetWidth;
          panelEl.classList.add("panel-animate-in");
        }, 220);
      };

      const renderTabs = (establishments) => {
        tabsEl.innerHTML = establishments
          .map(
            (est) =>
              '<button data-id="' +
              est.id +
              '" class="tab-button rounded-full border border-[#1d1b16] px-5 py-2 text-xs font-semibold uppercase tracking-widest text-[#1d1b16]">' +
              est.name +
              "</button>"
          )
          .join("");

        Array.from(tabsEl.querySelectorAll("button")).forEach((button) => {
          button.addEventListener("click", () => {
            const selected = establishments.find(
              (est) => est.id === button.dataset.id
            );
            if (selected) {
              animateSwitch(selected);
            }
          });
        });
      };

      const requestSales = async (establishments) => {
        const response = await fetch("/sim/trigger", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            businessIds: establishments.map((item) => item.id),
          }),
        });
        return response.json();
      };

      const init = async () => {
        dataCache = await fetchData();
        const establishments = dataCache.establishments || [];
        renderTabs(establishments);
        if (establishments.length > 0) {
          renderEstablishment(establishments[0]);
          panelEl.classList.add("panel-animate-in");
          setInterval(() => updateStatus(currentShop), 60000);
        }
        if (saleButtonEl) {
          saleButtonEl.addEventListener("click", async () => {
            try {
              saleButtonEl.disabled = true;
              saleButtonEl.textContent = "Generating...";
              const payload = await requestSales(establishments);
              openSaleModal(payload);
            } catch (error) {
              openSaleModal({
                results: [
                  {
                    name: "Error",
                    logo: "/assets/wolf.png",
                    orders: [],
                  },
                ],
              });
            } finally {
              saleButtonEl.disabled = false;
              saleButtonEl.textContent = "Make Sale";
            }
          });
        }
        if (makeAnotherSaleEl) {
          makeAnotherSaleEl.addEventListener("click", async () => {
            try {
              makeAnotherSaleEl.disabled = true;
              makeAnotherSaleEl.textContent = "Generating...";
              const payload = await requestSales(establishments);
              openSaleModal(payload);
            } catch (error) {
              openSaleModal({
                results: [
                  {
                    name: "Error",
                    logo: "/assets/wolf.png",
                    orders: [],
                  },
                ],
              });
            } finally {
              makeAnotherSaleEl.disabled = false;
              makeAnotherSaleEl.textContent = "Make Another";
            }
          });
        }
        if (closeSaleModalEl) {
          closeSaleModalEl.addEventListener("click", closeSaleModal);
        }
        if (closeItemModalEl) {
          closeItemModalEl.addEventListener("click", closeItemModal);
        }
        if (saleModalEl) {
          saleModalEl.addEventListener("click", (event) => {
            if (event.target === saleModalEl) {
              closeSaleModal();
            }
          });
        }
        if (itemModalEl) {
          itemModalEl.addEventListener("click", (event) => {
            if (event.target === itemModalEl) {
              closeItemModal();
            }
          });
        }
        if (sectionRowsEl) {
          sectionRowsEl.addEventListener("click", (event) => {
            const rowEl = event.target.closest("tr[data-row-index]");
            if (!rowEl) return;
            const idx = Number(rowEl.dataset.rowIndex);
            renderItemModal(currentSectionRows[idx]);
          });
        }
        document.addEventListener("keydown", (event) => {
          if (event.key === "Escape") closeSaleModal();
          if (event.key === "Escape") closeItemModal();
        });
      };

      init().catch((error) => {
        itemsEl.innerHTML =
          '<p class="text-sm text-[#4b443b]">' +
          error.message +
          "</p>";
      });
    </script>
  </body>
</html>
